name: Releasing

on:
  workflow_dispatch:

jobs:
  lint:
    uses: despores/shri-infra-homework/.github/workflows/lint.yml@main

  test:
    uses: despores/shri-infra-homework/.github/workflows/test.yml@main

  create-release:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create release branch
        run: git checkout -b releases/${{ github.run_number }}

      - name: Login to Yandex Cloud
        run: |
          echo "${{ secrets.OAUTH_KEY }}" | docker login --username oauth --password-stdin cr.yandex

      - name: Create docker image
        run: docker build -t cr.yandex/${{ secrets.CONTAINER_REGISTRY_ID }}/app:${{ github.run_number }} -t cr.yandex/${{ secrets.CONTAINER_REGISTRY_ID }}/app:${{ github.run_number }}_latest .

      - name: Upload docker image to Container Registry
        run: docker push --all-tags cr.yandex/${{ secrets.CONTAINER_REGISTRY_ID }}/app

      - name: Push release branch
        run: git push -u origin releases/${{ github.run_number }}

      - name: Create tag
        run: |
          git checkout main
          git tag release-version-${{ github.run_number }}
  


